<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Title</title>
  </head>
  <body>

  </body>
</html>
<script>
  let handler = {
    has(target, key) {
      if (key in target) {
        return target[key]
      } else {
        throw `无法访问属性或方法 ${key}, 详情请参考：https://www.google.com`
        // throw new Error(`无法访问属性或方法 ${key}, 详情请参考：https://www.google.com`)
        return undefined
      }
    }
  }

  let target = {
    console: window.console,
    Math: window.Math,
    Date: window.Date,

    name: "i am module"
  }

  let proxy = new Proxy(target, handler)

  let moduleCode = `
      console.log('this1:',this); // this指向proxy

      function foo(){
          console.log(name);

          // this === window 此写法会造成沙箱逃逸
          console.log("this2:", this); // this是AO，AO作为this值返回时通常为null，this不能为null，重置为全局对象。
          console.log(this.document);

          function bar(){
              var b = 10;
              console.log("b: ",b);
              console.log(Math.random());
              console.log(new Date());
              console.log(document.getElementById('p'));
              console.log(window);
          }

          bar();
      }

      foo()
  `

  let fun = new Function("window", `
        "use stric";

        with(window){
            ${moduleCode}
        }
    `)

  fun.call(proxy, proxy)
</script>