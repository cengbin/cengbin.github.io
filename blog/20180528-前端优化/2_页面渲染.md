# 页面渲染  

## 一、网页生成的过程
要理解网页性能为什么不好，就要了解网页是怎么生成的。
![](./image/2015-09-17_55fa6a99be423.png)

网页的生成过程，大致可以分成五步。

>1. HTML代码转化成DOM
2. CSS代码转化成CSSOM（CSS Object Model）
3. 结合DOM和CSSOM，生成一棵渲染树（包含每个节点的视觉信息）
4. 生成布局（layout），即将所有渲染树的所有节点进行平面合成
5. 将布局绘制（paint）在屏幕上

这五步里面，第一步到第三步都非常快，耗时的是第四步和第五步。

"生成布局"（flow）和"绘制"（paint）这两步，合称为"渲染"（render）。

![](./image/2015-09-17_55fa6a99ed209.png)

## 二、重排和重绘

网页生成的时候，至少会渲染一次。用户访问的过程中，还会不断重新渲染。

以下三种情况，会导致网页重新渲染。

    修改DOM
    修改样式表
    用户事件（比如鼠标悬停、页面滚动、输入框键入文字、改变窗口大小等等）

重新渲染，就需要重新生成布局和重新绘制。前者叫做"重排"（reflow），后者叫做"重绘"（repaint）。

需要注意的是，"重绘"不一定需要"重排"，比如改变某个网页元素的颜色，就只会触发"重绘"，不会触发"重排"，因为布局没有改变。但是，"重排"必然导致"重绘"，比如改变一个网页元素的位置，就会同时触发"重排"和"重绘"，因为布局改变了。



# 第四章-css 和 js 的装载与执行
* **顺序执行，并发加载：**
head(css) body(div script)

* **是否阻塞：**
    - css阻塞，css通过link放在head阻塞页面的渲染（防止dom加载完成后-出现样式闪动）；css阻塞内部js的执行（js可能会改变dom），css不阻塞外部脚本的并发加载
    - js阻塞，直接引入的js阻塞页面的渲染（js没有加载完，页面没有dom内容），不阻塞加载（放在body后面）；js不阻塞资源的加载；js顺序执行，阻塞后续js逻辑的执行

* **依赖关系：**
页面渲染依赖css的加载；
js的执行顺序有依赖关系；
js逻辑dom节点有依赖关系；

* js引入的方式  
- 直接引入
- defer，不阻塞html的渲染；dom树构建完成执行；顺序执行（等同直接引入）
- async，不阻塞html的渲染；不按照加载的先后顺序执行，不遵循依赖关系，服务端返回就立马执行
- 异步动态引入js
* **引入方式：**
css样式表置顶；用link代替import（以前--在css中通过import不会触发浏览并发机制，在body最后执行，可以在css内部使用；@import/link内部通过@import引入的css不能并发加载 ）；js脚本置底；合理使用js的异步加载能力（dom加载完成后，用defer）

# 第5章-懒加载和预加载
**懒加载：** 适用图片很多、页面很长；并发加载资源过多阻塞js加载；图片进入可视区域之后请求图片资源;监听onscrrol
**预加载：** 静态资源在使用之前的提前请求；从缓存加载；页面展示的依赖关系维护(src加载，xml请求-跨域)
**实战**模块化快发，先加载首屏。

## 第6章-重绘与回流
**回流：**
当 render tree中的一部分或全部因为元素的规模尺寸、布局、隐藏等改变而需要重新构建；当页面布局和几何属性改变时
**影响回流的css属性**
- 盒子模型相关属性，width padding border
- 定位属性及浮动,top position clear float
- 改变节点内部文字结构,font-weight text-align overflow
**重绘：**
当 render tree中的一些元素需要更新属性，而这些属性只是影响元素的外观、风格，而不会影响布局，比如background-color
**影响重绘的css元素**
- color border-style background outline box-shadow

**实战优化点**
- 不要一条一条的修改dom的样式，预先定义好class，然后修改dom的className
- 启用GPU硬件加速

JS阻塞页面加载：
JS引擎执行时GUI线程会被挂起，JS执行时间也会阻塞页面渲染。所以，要尽量避免JS执行时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞的感觉。这块儿可以做一些算法上面优化之类的。

这个游戏中会做到对象池的引用，减少内存增加。

### 参考链接：
网页性能管理详解 http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html
网页性能管理详解 https://www.kancloud.cn/digest/web-page-performance-in-depth/65359